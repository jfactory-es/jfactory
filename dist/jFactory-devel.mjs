import e from"lodash";import t from"jquery";
/*!
 * jFactory, Copyright (c) 2019, StÃ©phane Plazis
 * https://github.com/jfactory-es/jfactory/blob/master/LICENSE.txt
 */
const s=!0,r=!1,i="undefined"!=typeof process&&process.versions&&process.versions.node,n={TraitLog:!i||!1,JFactoryError:{keys:["$.about.name","$dev_name","$name","name","id"]},JFactoryTrace:!i&&{keys:["$dev_traceLog","$dev_traceSource"],libOptions:{offline:Boolean(globalThis.chrome),filter:function(e){return e.lineNumber}}},jFactoryDev:{requireCompatibility:{globalThis:{test:()=>globalThis,info:"https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/globalThis"},fetch:{test:()=>fetch,info:"https://developer.mozilla.org/docs/Web/API/Fetch_API/Using_Fetch"},Request:{test:()=>Request,info:"https://developer.mozilla.org/docs/Web/API/Request"},"AbortController, AbortSignal":{test:()=>(new AbortController).signal,info:"https://developer.mozilla.org/docs/Web/API/AbortController, https://developer.mozilla.org/docs/Web/API/AbortSignal"},MutationObserver:{test:()=>MutationObserver,info:"https://developer.mozilla.org/docs/Web/API/MutationObserver"}}}},a={seq:[],init(){if(this.seq){let e=this.seq;delete this.seq;for(let t of e)t();delete globalThis.jFactoryOverride}},onInit(e){this.seq.push(e)}};function o(){console.warn("jFactory: RUNNING IN DEVELOPER MODE, PERFORMANCES WILL BE AFFECTED");for(let[e,t]of Object.entries(n.jFactoryDev.requireCompatibility)){let s;try{s=Boolean(t.test())}catch(e){}s||console.warn(`jFactory may require the support of "${e}", ${t.info}`)}}function l(){!n.TraitLog&&s&&console.warn("jFactory: LOGS REMOVED")}a.onInit(o),a.onInit(l);const c=t,h=e.isNative,u=e.isString,d=e.isNumber,p=e.isPlainObject,f=e.defaultsDeep,m=e.lowerFirst,$=e.get,g=e.template,v=e.camelCase,b=()=>{},E=(e,t)=>Object.defineProperty(t,"name",{value:e});class A{constructor({label:e,stackTraceLimit:t,keys:s,libOptions:r}={}){this.label=e||"The stack has been printed in the console",this.stackTraceLimit=t||1/0,this.keys=s||["stackLog","stackSource"],this.libOptions=r||{}}captureTraceSource(e,t){let s;this.stackTraceLimit&&(s=Error.stackTraceLimit,Error.stackTraceLimit=this.stackTraceLimit),e||(e="captureTraceSource",t=!0);let r={source:new Error,omitAboveFunctionName:e,omitSelf:t};return this.stackTraceLimit&&(Error.stackTraceLimit=s),r}attachTrace(e,t){"object"!=typeof t&&(t=this.captureTraceSource(t||"attachTrace",!t));let s=t.source;this.toPrintableTrace(t).then(e=>s=e);let r=()=>console.log(s)||this.label;Object.defineProperty(e,this.keys[0],{enumerable:!1,configurable:!0,get:()=>r()}),Object.defineProperty(e,this.keys[1],{enumerable:!1,configurable:!0,get:()=>t})}toPrintableTrace(e){return Promise.resolve(e.source)}}class y extends A{constructor(e){super(e)}toPrintableTrace(e){return StackTrace.fromError(e.source,this.libOptions).then(t=>{if(e.omitAboveFunctionName){let s=t.findIndex(t=>t.functionName&&t.functionName.endsWith(e.omitAboveFunctionName));s>0&&(e.omitSelf&&s++,t=t.slice(s))}return t=t.filter(this.libOptions.filter),this.formatTraceFrames(t)})}formatTraceFrames(e){let t,s;return this.libOptions.offline&&window.chrome?(t="Error\n",s="\tat "):(t="",s=""),t+e.map(e=>s+e.toString()).join("\n")}}const S={};a.onInit((function(){let e=n.JFactoryTrace;if(e&&!1!==e.use){let t;(t="function"==typeof e.use?e.use:"object"==typeof StackTrace?y:(console.warn("jFactory: StackTrace lib not found, using fallback"),A))===y&&console.warn("jFactory: Stack trace enabled; Performance will be affected"),S.tracer=new t(e)}else S.tracer={captureTraceSource:b,attachTrace:b}}));class R extends Error{constructor(e="unspecified error",t=null){t=Object.assign(Object.create(null),t),super(e=R.toPrintable(e,t)),this.$data=Object.assign(Object.create(null),t)}toString(){return this.message}*[Symbol.iterator](){yield this.message,yield this.$data}static getId(e){return e[(n.JFactoryError.keys||R.DEFAULT_KEYS).find(t=>{let s=$(e,t);return s||0===s})]}static toPrintableData(e){const t={};let s;for(let[r,i]of Object.entries(e)){switch(typeof i){case"function":i=i.name+"()";break;case"object":if(null===i){i="null";break}if(i instanceof Error){i=i.toString();break}if(void 0!==(s=R.getId(i)))i='"'+s+'"';else if(h(i.toString))try{i=(s=JSON.stringify(i)).length>R.JSON_MAX?s.substring(0,R.JSON_MAX)+"[...]":s}catch(e){i="[object "+i.constructor.name+"]"}else i=i.toString();break;case"string":i='"'+i+'"';break;default:i=String(i)}t[r]=i}return t}static toPrintable(e,t){const s=[];for(let r of e.split(";")){let e,i=R.RE_PLACEHOLDER;if(i.lastIndex=0,e=i.exec(r)){do{if(e[1]&&e[1]in t){s.push(r.trim());break}}while(null!==(e=i.exec(r)))}else s.push(r.trim())}return m(g(s.join("; "))(R.toPrintableData(t)))}}R.JSON_MAX=40,R.DEFAULT_KEYS=["name","id"],R.RE_PLACEHOLDER=/\${([^}]+)}/g;let _=new Proxy(R,{set:function(e,t,s){let{template:r}=s;if(e[t])throw new Error("already declared");return e[t]=class extends R{constructor(e,t){super(r,e),S.tracer.attachTrace(this.$data,t)}},e[t].prototype.name="Error jFactoryError."+t,!0}});function L(e,t){if(!new.target)return new L(e,t);this.label=e,this.value=t}_.INVALID_VALUE={template:"invalid value for ${target}; Reason: ${reason}; Given: ${given}"},_.INVALID_CALL={template:"invalid call ${target}; Reason: ${reason}; Owner: ${owner}"},_.PROMISE_EXPIRED={template:"expired promise ${target}; Reason: ${reason}"},_.REQUEST_ERROR={template:"error requesting ${target}; Reason: ${reason}; Owner: ${owner}"},_.KEY_DUPLICATED={template:"duplicated key for ${target}; Given: ${given}"},_.KEY_MISSING={template:"missing key for ${target}; Given: ${given}"};const O=function(e,t,s){throw new _.INVALID_VALUE({target:e,reason:s,given:t})},P={notUndefined:(e,t)=>(void 0===t&&O(e,t,"cannot be undefined"),!0),notEmptyString:(e,t)=>(""===t&&O(e,t,"cannot be empty string"),!0),notFalsy:(e,t)=>(t||O(e,t,'cannot be a falsy value (undefined, null, NaN, 0, "")'),!0),validSpaces:(e,t)=>(t.replace&&t.replace(/\s+/g," ").trim()===t||O(e,t,"invalid space delimiters"),!0),matchReg:(e,t,s)=>(s.test(t)||O(e,t,'string "'+t+'" must match '+s),!0),type(e,t,...s){let r,i=!1;for(let n of s){null===n?r="Null":"name"in n&&(r=n.name);let s=P["type"+r];if(s)try{i=s(e,t)}catch(e){}else i=t instanceof n;if(i)break}return i||O(e,t,"must be an instance of ["+s.map(e=>e.name).join(", ")+"]"),!0},typeNull:(e,t)=>(null!==t&&O(e,t,"must be null"),!0),typeBoolean:(e,t)=>(!0!==t&&!1!==t&&O(e,t,"must be a boolean"),!0),typeString:(e,t)=>(u(t)||O(e,t,"must be a string"),!0),typeNumber:(e,t)=>(d(t)||O(e,t,"must be a number"),!0),typeFunction:(e,t)=>("function"!=typeof t&&O(e,t,"must be a function"),!0),typePlainObject:(e,t)=>(p(t)||O(e,t,"must be a plain object"),!0),equal(e,t,...s){let r=!1;for(let e of s)if(r=t===e)break;return r||O(e,t,"must be one of ["+s+"]"),!0},equalIn:(e,t,s)=>(Array.isArray(s)||(s=Object.values(s)),s.includes(t)||O(e,t,"must be one from ["+s.join(", ")+"]"),!0),properties(e,t,s){for(let r of Object.getOwnPropertyNames(t))L(e+', property name "'+r+'"',r).equalIn(s);return!0},writable:(e,t,s)=>(Object.getOwnPropertyDescriptor(t,s).writable||O(e,t,"must be writable"),!0),notWritable:(e,t,s)=>(Object.getOwnPropertyDescriptor(t,s).writable&&O(e,t,"must not be writable"),!0),enumerable:(e,t,s)=>(Object.prototype.propertyIsEnumerable.call(t,s)||O(e,t,"must be enumerable"),!0),notEnumerable:(e,t,s)=>(Object.prototype.propertyIsEnumerable.call(t,s)&&O(e,t,"must not be enumerable"),!0),configurable:(e,t,s)=>(Object.getOwnPropertyDescriptor(t,s).configurable||O(e,t,"must be configurable"),!0),notConfigurable:(e,t,s)=>(Object.getOwnPropertyDescriptor(t,s).configurable&&O(e,t,"must not be configurable"),!0),reservedProperty:(e,t,s)=>(s in t&&O(e,t,"is a reserved property"),!0)};a.onInit((function(){Object.assign(L,P);for(const e of Object.getOwnPropertyNames(P))L.prototype[e]=function(...t){return L[e](this.label,this.value,...t),this}}));class w{constructor(e,t,s={}){this.callerInstance=e,this.callerConstructor=t,this.options=s}use(e,...t){L("JFactoryTraits(trait)",e).typeFunction();let{callerInstance:s,callerConstructor:r}=this,i=w.CACHE.get(s);if(i){if(i.has(e))return n.TraitLog&&console.warn(`${e.name} already called on`,s),this;i.add(e)}else w.CACHE.set(s,new WeakSet([e]));!r.JFactoryTrait&&(r.JFactoryTrait=new WeakSet),r.JFactoryTrait.has(e)||(r.JFactoryTrait.add(e),this.export(e.prototype,r.prototype),this.export(e,r,!0));let a=new e(s,...t);return a.trait_constructor&&a.trait_constructor.apply(s,t),this}export(e,t,s){let r=Object.getOwnPropertyDescriptors(e);for(let i of Object.keys(r)){let n=w.getPrefix(i);if(w.getTarget(i,t,n)){let n=r[i],a=(this.options.parser||w.defaultParser)(i,n,e,t,s);a&&(({propertyName:i,propertyDescriptor:n}=a),Object.defineProperty(t,i,n))}}}static defaultParser(e,t,s,r,i){let a=t.value;return i?null:e in r?(n.TraitLog&&console.warn(`${r.constructor.name}> skipping export of existing property "${e}"`,a),null):"object"==typeof a?(n.TraitLog&&console.warn(`${r.constructor.name}> skipping export of shared object "${e}"`,a),null):{propertyName:e,propertyDescriptor:t}}static getPrefix(e){let t=e.split("_");return t.length>1?t[0]:null}static getTarget(e,t,s){return w.EXCLUDES.includes(e)||"trait"===s?null:t}}w.CACHE=new WeakMap,w.EXCLUDES=["constructor","prototype","length","size"];class T{constructor(){this.handlers=Object.create(null)}*[Symbol.iterator](e=[]){e.length||(e=Object.keys(this.handlers)),e.length||(e=["default"]);for(let t of e)t in this.handlers&&(yield*this.handlers[t])}first(e,t){return 1===arguments.length&&([e,t]=["default",e]),(this.handlers[e]||(this.handlers[e]=[])).unshift(t),this}last(e,t){return 1===arguments.length&&([e,t]=["default",e]),(this.handlers[e]||(this.handlers[e]=[])).push(t),this}compose(...e){let t=this,s=function(){let s={canceled:!1,parameters:Array.from(arguments),result:void 0},r=t[Symbol.iterator](e),i=r.next();return T.composite_iterator(this,s,i,r)};return s.composer=t,s}static composite_iterator(e,t,s,r){let i,n;for(;!t.canceled&&!s.done;)if(i=s.value,n=e?i.call(e,t,...t.parameters):i(t,...t.parameters),s=r.next(),n instanceof Promise){if(!s.done||n.constructor===Promise)return n.then(E([i.name,"compositeAsyncHandler"].filter(Boolean).join(" "),(function(i){return t.result=i,T.composite_iterator(e,t,s,r)})));t.result=n}else t.result=n;return t.result}}function I(e){return new N(e).compose()}class N{constructor(e){this.originalHandler=e,this.expiredCalls=0,this.composer=new T;let t,s=this.composer.compose("conditions"),r=this;this.isExpired=e=>t||s.call(e)||!1,this.setExpired=e=>t=e?e instanceof Error?e:new _.INVALID_CALL({target:this.originalHandler,reason:"manually expired"}):Boolean(this.expiredCalls=0),this.addExpireCondition=function(e){this.composer.last("conditions",(function(t){let s=function(s){return L("JFactoryFunctionExpirable.addExpireCondition(), result",s).type(Boolean,Error),r.setExpired(!!s&&((t.canceled=!0)&&(s instanceof Error?s:new _.INVALID_CALL({target:r.originalHandler,reason:"conditionally expired",condition:e}))))},i=e.apply(this,t.parameters);return i instanceof Promise?i.then(s):s(i)}))}}compose(){let e=this,t=function(){let t=e.isExpired(this),s=e.constructor.call.bind(void 0,e,this,arguments);return t instanceof Promise?t.then(s):s(t)};return Object.assign(t,{expirable:this,isExpired:e=>this.isExpired(e),setExpired:e=>this.setExpired(e),addExpireCondition:e=>(this.addExpireCondition(e),t)})}static call(e,t,s,r){return r?e.onExpired(r):e.onNotExpired(t,s)}onExpired(e){return this.expiredCalls<N.MaxWarningExpiration&&(this.expiredCalls++,n.TraitLog&&console.warn(...new _.INVALID_CALL({...e.$data,reason:e.$data.reason+"; expiredCalls="+this.expiredCalls+(this.expiredCalls===N.MaxWarningExpiration?"; Max Warning Exceeded":"")}))),e}onNotExpired(e,t){return this.originalHandler.apply(e,t)}}function j(e){return new C(e).compose()}N.MaxWarningExpiration=10;class C{constructor(e){this.originalHandler=e,this.composer=new T,this.composer.first("original",E([e.name,"condition"].filter(Boolean).join(" "),(function(t){return e.apply(this,t.parameters)})))}compose(){let e=this.composer.compose("conditions","original");return Object.assign(e,{conditional:this,addCondition:t=>(this.addCondition(t),e)})}addCondition(e){this.composer.last("conditions",(function(t){let s=function(e){L("JFactoryFunctionConditional.addCondition(), result",e).typeBoolean(),!e&&(t.canceled=!0)},r=e.apply(this,t.parameters);return r instanceof Promise?r.then(s):s(r)}))}}function k(e){return new F(e).compose()}class F{constructor(e){this.originalHandler=e,this.composer=new T,this.composer.first("original",E([e.name,"wrapped"].filter(Boolean).join(" "),(function(t){return e.apply(this,t.parameters)})))}compose(){let e=this.composer.compose("before","original","after");return Object.assign(e,{wrappable:this,beforeAll:t=>(this.beforeAll(t),e),justBefore:t=>(this.justBefore(t),e),justAfter:t=>(this.justAfter(t),e),afterAll:t=>(this.afterAll(t),e)})}beforeAll(e){this.composer.first("before",e)}justBefore(e){this.composer.last("before",e)}justAfter(e){this.composer.first("after",e)}afterAll(e){this.composer.last("after",e)}}function M(e,t){return new w(e,t,{parser(e,t){let s=w.defaultParser(...arguments);if(s){({propertyName:e,propertyDescriptor:t}=s);let r=t.value;if("function"==typeof r)switch(r.name){case"$install":case"$uninstall":case"$enable":case"$disable":case"$state":break;default:t.value=k(r).beforeAll((function(){if(!this.$.states.enabled&&"PHASE_NONE"===this.$.service.phase){let e=new _.INVALID_CALL({owner:this,target:r,reason:"component disabled"});throw this.$logErr(...e),e}}))}return{propertyName:e,propertyDescriptor:t}}}})}class D{constructor(e){M(this,D).use(U.TraitCore).use(U.TraitAbout,{name:e}).use(U.TraitLog).use(U.TraitEvents).use(U.TraitState).use(U.TraitService).use(U.TraitTask)}}class B extends D{constructor(e){super(e),M(this,B).use(U.TraitFetch).use(U.TraitDOM).use(U.TraitCSS).use(U.TraitMutation).use(U.TraitTimeout).use(U.TraitInterval)}}const U=(e,t)=>Object.assign(new B(e),t);class H{static createDescriptors(e=H.DESCRIPTORS_PROTOTYPE){let t=H.create(e,!0,!0),s=Object.create(null);return s.NONE=t(),s.WRITABLE=t({writable:!0}),s.ENUMERABLE=t({enumerable:!0}),s.CONFIGURABLE=t({configurable:!0}),s.CONFIGURABLE_WRITABLE=s.WRITABLE_CONFIGURABLE=t({writable:!0,configurable:!0}),s.CONFIGURABLE_ENUMERABLE=s.ENUMERABLE_CONFIGURABLE=t({enumerable:!0,configurable:!0}),s.ENUMERABLE_WRITABLE=s.WRITABLE_ENUMERABLE=t({writable:!0,enumerable:!0}),s.WRITABLE_ENUMERABLE_CONFIGURABLE=s.WRITABLE_CONFIGURABLE_ENUMERABLE=s.ENUMERABLE_CONFIGURABLE_WRITABLE=s.ENUMERABLE_WRITABLE_CONFIGURABLE=s.CONFIGURABLE_WRITABLE_ENUMERABLE=s.CONFIGURABLE_ENUMERABLE_WRITABLE=t({writable:!0,enumerable:!0,configurable:!0}),s.READONLY=t({writable:!1,enumerable:!1,configurable:!1}),s}static assign(e,t,s,r){let i={};switch(typeof t){case"string":case"symbol":if(!r)throw new Error("missing descriptor argument; use Object.assign instead");(r=Object.create(r)).value=s,Object.defineProperty(e,t,r);break;case"object":if([s,r]=[t,s],!r)throw new Error("missing descriptor argument; use Object.assign instead");for(let e of Object.getOwnPropertyNames(s))i[e]=Object.create(r),i[e].value=s[e];for(let e of Object.getOwnPropertySymbols(s))i[e]=Object.create(r),i[e].value=s[e];Object.defineProperties(e,i);break;default:throw new Error("invalid property argument")}return e}static create(e,t=!1,s=!1){return function(r){return t?Object.assign(s?Object.create(null):{},e,r):Object.assign(Object.create(s?Object.assign(Object.create(null),e):e),r)}}static disinherit(e){return Object.assign(Object.create(null),e)}}H.DESCRIPTORS_PROTOTYPE={writable:!1,enumerable:!1,configurable:!1},a.onInit((function(){H.descriptors=H.createDescriptors()}));const V=()=>++V.uid;V.uid=0;class Y{constructor(e,t={}){let s,r;L("JFactoryAbout(owner)",e).type(Object),L("JFactoryAbout(about)",t).typePlainObject().reservedProperty("uid").reservedProperty("fingerprint"),"name"in t&&L("JFactoryAbout(about.name)",t.name).typeString().notEmptyString();let i=V();t.name?(s=t.name,delete t.name,r="jFactory_"+v(s.toLowerCase())+"_"+i):(delete t.name,s=`[${e.constructor.name}#${i}]`,r="jFactory_"+e.constructor.name+"_"+i),H.assign(this,{uid:i,name:s,fingerprint:r},H.descriptors.ENUMERABLE),Object.assign(this,t),L("JFactoryAbout.name",this.name).matchReg(/^[\w[\]#]+$/),L("JFactoryAbout.fingerprint",this.fingerprint).matchReg(/^[\w]+$/)}}const q=()=>++q.uid;q.uid=0;class J extends Promise{constructor({name:e,config:t,traceSource:s},r){1===arguments.length&&([e,t,r]=[null,null,arguments[0]]);const i=q();let n,a;t={...J.DEFAULT_CONFIG,...t},L("name",e=e||"unnamed").type(String,Number).matchReg(/^[^. ]+$/),L("config",t).typePlainObject(),L("executor",r).typeFunction(),super((e,t)=>{n=e,a=t});const o=new W(this,i,e,t);Object.defineProperties(this,{$chain:{enumerable:!0,writable:!0,value:o},$type:{writable:!0,value:"promise"},$value:{writable:!0,value:void 0},$isSettled:{writable:!0,value:!1},$isRejected:{writable:!0,value:null},$isFulfilled:{writable:!0,value:null},$isExpired:{writable:!0,value:!1}}),Object.defineProperties(this,{$dev_name:{configurable:!0,value:e+"["+i+":0]"},$dev_path:{writable:!0,value:new K(this)},$dev_position:{writable:!0,value:0}}),h(r)||Object.defineProperties(this,{$dev_source:{value:r}}),S.tracer.attachTrace(this,s);const l=()=>{if(!this.$chain.isPending)try{this.$chainComplete("config.chainAutoComplete = true")}catch(e){console.error(e)}},c=e=>{if(!this.$isSettled){if(e===this)return void u(new TypeError("Chaining cycle detected for promise "+this.$dev_name));let t;if(null!==e&&("object"==typeof e||"function"==typeof x))try{t=e.then}catch(e){return void u(e)}if("function"==typeof t){let s=!1,r=function(e){s||(s=!0,c(e))},i=function(e){s||(s=!0,u(e))};try{t.call(e,r,i)}catch(e){s||u(e)}}else this.$isRejected=!1,this.$isFulfilled=!0,this.$isExpired&&(e=this.$chain.errorExpired),n(e),d(e)}},u=e=>{this.$isSettled||(this.$isRejected=!0,this.$isFulfilled=!1,a(e),d(e))},d=e=>{this.$value=e,this.$isSettled=!0,this.$chain.chainMap.set(this,!0),this.$chain.chainConfig.chainAutoComplete&&(1!==this.$chain.chainMap.size||this.$isExpired?l():this.then(l))};let p=t.chainAutoComplete;Object.defineProperty(t,"chainAutoComplete",{get:()=>p,set:e=>{p!==e&&(p=e,e&&l())}}),o.chainMap.set(this,!1),Object.defineProperties(this,{__resolve__:{value:c},__reject__:{value:u}});try{r(c,u)}catch(e){u(e)}}then(e,t,s){let r,i,n,a=h(e)&&!e.name.startsWith("bound ");e&&"function"==typeof e&&(r=function(s){return"await"===o&&!0===n.$isExpired&&n.$chain.errorExpired===s?t(s):n.$isSettled?void 0:e(s)}),t&&"function"==typeof t&&(i=function(e){if(!n.$isSettled)return t(e)});let o=s||(a?"await":void 0===e?"catch":"then");n=Object.assign(super.then(r,i),this),q.uid--,n.$type=o;{n.$dev_position=this.$chain.chainMap.size;let s="";e&&e.name&&(s+=e.name),t&&t.name&&(s+=","+t.name),Object.defineProperties(n,{$dev_name:{value:this.$chain.chainName+"["+this.$chain.chainId+":"+this.$dev_position+"]."+n.$type+(s?"("+s+")":"")+"["+n.$chain.chainId+":"+n.$dev_position+"]"},$dev_path:{value:new K(this.$dev_path,n)},$dev_onFulfilled:{value:e},$dev_onRejected:{value:t}})}return n.$chain.chainMap.set(n,!1),this.$isExpired&&J.forceExpire(n,this.$chain.errorExpired),n}$catchExpired(e){return this.then(t=>this.$chain.chainRoot.$isExpired?e(t):t,void 0,"$catchExpired")}static resolve(e,t){return 1===arguments.length&&([e,t]=[{},e]),e||(e={}),t instanceof this&&1===arguments.length?t:new this(e,(function(e){e(t)}))}static reject(e,t){return 1===arguments.length&&([e,t]=[{},e]),e||(e={}),new this(e,(function(e,s){s(t)}))}$toPromise(){return Promise.resolve(this)}$chainAbort(e="$chainAbort()"){return this.$chain.complete(e),this}$chainComplete(e="$chainComplete()"){return this.$chain.complete(e),this}$chainAutoComplete(){return this.$chain.chainConfig.chainAutoComplete=!0,this}static forceExpire(e,t){e.$isExpired=!0,e.$isSettled||"await"!==e.$type&&"$catchExpired"!==e.$type&&e.__resolve__(t)}}J.DEFAULT_CONFIG={chainAutoComplete:!1};class W{constructor(e,t,s,r){Object.defineProperties(this,{chainConfig:{value:r},chainRoot:{value:e},chainId:{value:t},chainName:{value:s},chainMap:{value:new Map},isCompleted:{value:!1,configurable:!0},data:{value:{}},__deferred__:{value:c.Deferred()}})}get isPending(){return Array.from(this.chainMap.values()).includes(!1)}then(e){return this.__deferred__.done(e),this}complete(e="chain.complete()"){let t=this.chainRoot;if(!t.$isExpired){let s=t.$chain.errorExpired=new _.PROMISE_EXPIRED({target:t,reason:e}),r=this.chainMap;for(let e of r.keys())J.forceExpire(e,s);Object.defineProperty(this,"isCompleted",{value:!0}),this.__deferred__.resolve()}return this}}class K extends Array{constructor(){super();for(let e of arguments)Array.isArray(e)?this.push(...e):this.push(e)}get printable(){return this.map((e,t)=>0===t?e.$dev_name:e.$dev_name.split(".")[1]).join(".")}toString(){return this.printable}}class G extends Promise{constructor(e){let t={$isSettled:!1,$isRejected:null,$value:void 0};super((s,r)=>{let i=!1,n=e=>{e instanceof Promise?G.resolve(e).then(n,a):i||(i=!0,t.$isSettled=!0,t.$isRejected=!1,t.$value=e,s(e))},a=e=>{i||(i=!0,t.$isSettled=!0,t.$isRejected=!0,t.$value=e,r(e))};try{e(n,a)}catch(e){a(e)}}),Object.assign(this,t),t=this}then(e,t){if(this.$isSettled){let s=this.$value;try{if(this.$isRejected){if(super.then(void 0,()=>null),!t||"function"!=typeof t)return G.reject(s);s=t(s)}else e&&"function"==typeof e&&(s=e(s))}catch(e){return G.reject(e)}return G.resolve(s)}return super.then(e,t)}static resolve(e){return e instanceof G?e:e instanceof Promise?new G(e.then.bind(e)):new G(t=>t(e))}}class z{constructor(){Object.defineProperties(this,{registry:{value:c(Object.create(null))},handlers:{value:new WeakMap},onListenerUpdate:{value:null,writable:!0},onObserverUpdate:{value:null,writable:!0}})}on({events:e,handler:t,target:s,selector:r}){z.validateSelector(e),L("JFactoryEvents.on({handler})",t).typeFunction(),s&&L("JFactoryEvents.on({target})",s).type(String,c,HTMLElement),r&&L("JFactoryEvents.on({selector})",s).typeString();let i=this.handlers.get(t);s?(i||this.handlers.set(t,!0),r?c(s).on(e,r,t):c(s).on(e,t),this.onListenerUpdate&&this.onListenerUpdate(arguments)):(i||(this.handlers.set(t,i=function(e,{data:s,stack:r}){r.push(()=>t(e,s))}),i.originalHandler=t),this.registry.on(e,i),this.onObserverUpdate&&this.onObserverUpdate(arguments))}off({events:e,handler:t,target:s,selector:r}){if(void 0!==e&&(z.validateSelector(e),t&&L("JFactoryEvents.off({handler})",t).typeFunction(),s&&L("JFactoryEvents.off({target})",s).type(String,c,HTMLElement),r&&L("JFactoryEvents.off({selector})",s).typeString()),s)r?c(s).off(e,r,t):c(s).off(e,t);else{if(c("*").off(e,t),t&&!(t=this.handlers.get(t)))throw new _.INVALID_VALUE({target:"handler",reason:"not registered",given:t});this.registry.off(e,t)}this.onObserverUpdate&&this.onObserverUpdate(arguments),this.onListenerUpdate&&this.onListenerUpdate(arguments)}triggerParallel({events:e,data:t,target:s}){z.validateSelector(e),s&&L("JFactoryEvents.triggerParallel({target})",s).type(String,c,HTMLElement);const r=[],i=[];if(e=e.split(" "),s)for(let i of e)c(s).trigger(i,{data:t,stack:r});else for(let s of e)this.registry.triggerHandler(s,{data:t,stack:r});for(let e of r){let t=e();t instanceof Promise&&!t.$isSettled&&i.push(t)}return i.length?Promise.all(i):G.resolve()}triggerSeries({events:e,data:t,target:s}){return z.validateSelector(e),s&&L("JFactoryEvents.triggerSeries({target})",s).type(String,c,HTMLElement),new G(async r=>{const i=[];if(e=e.split(" "),s)for(let r of e)c(s).trigger(r,{data:t,stack:i});else for(let s of e)this.registry.triggerHandler(s,{data:t,stack:i});for(let e of i){let t=e();t instanceof Promise&&!t.$isSettled&&await t}r()})}}class Q extends z{constructor(e){super(),Object.defineProperties(this,{parent:{value:e},affiliateRules:{value:(new T).compose()}}),this.affiliateAddRule(Q.rule_namespace)}affiliate(e="",t="",s){let r=new X(e);for(let e of r.events)this.affiliateRules(e,t,s);return r.toString()}affiliateAddRule(e){this.affiliateRules.composer.last(e)}static rule_namespace(e,t,s){s=s.split(".");for(let e of s)e&&t.addNamespace(e)}on(e,t,s,r,i){switch(arguments.length){case 2:[r,t]=[t];break;case 3:"function"==typeof arguments[2]?[r,s]=[s]:[r,i,t,s]=[t,s];break;case 4:"object"==typeof arguments[3]&&([i,r,s]=[r,s])}e=this.affiliate(e,this.parent.$.about.fingerprint,i),void 0===t?super.on({events:e,handler:r}):super.on({events:e,target:t,selector:s,handler:r})}off(e,t,s,r,i){const n=arguments.length;switch(n){case 1:"object"==typeof arguments[0]&&([i,e]=[e]);break;case 2:"function"==typeof arguments[1]?[r,t]=[t]:p(arguments[1])&&([i,t]=[t]);break;case 3:"function"==typeof arguments[2]?[r,s]=[s]:"function"==typeof arguments[1]&&([r,i,t,s]=[t,s]);break;case 4:"object"==typeof arguments[3]&&([i,r,s]=[r,s])}e=this.affiliate(e,this.parent.$.about.fingerprint,i),n<2?super.off({events:e}):t?super.off({events:e,target:t,selector:s,handler:r}):super.off({events:e,handler:r})}trigger(e,t,s){switch(arguments.length){case 2:"object"!=typeof t||t.jquery||([s,t]=[t])}return t?super.triggerSeries({events:e,target:t,data:s}):super.triggerSeries({events:e,data:s})}triggerParallel(e,t,s){switch(arguments.length){case 2:"object"!=typeof t||t.jquery||([s,t]=[t])}return t?super.triggerParallel({events:e,target:t,data:s}):super.triggerParallel({events:e,data:s})}getDomListeners(e){let t=new Map;for(let s of c("*")){let r=c._data(s,"events");if(r)for(let i of Object.values(r))for(let r of i){let i;if(new Z(r.namespace).hasNamespace(e)){(i=t.get(s))||t.set(s,i={}),(i[r.type]||(i[r.type]=[])).push({selector:r.selector||null,handler:r.handler,namespace:r.namespace})}}}return t}getObservers(){let e=new Map,t=this.registry._events;if(!t){let e=Object.values(this.registry)[0],s=Object.getOwnPropertyNames(e).find(e=>0===e.indexOf("jQuery"));e&&s&&(t=this.registry._events=e[s].events)}if(t)for(let[s,r]of Object.entries(t)){let t=e.get(s);t||(t=[],e.set(s,t));for(let e of r)t.push({handler:e.handler.originalHandler,namespace:e.namespace})}return e}}class X{constructor(e){z.validateSelector(e),this.events=e.split(" ").map(e=>new Z(e))}toString(){let e=[];for(let t of this.events)e.push(t.toString());return e.join(" ")}}class Z{constructor(e){let[t,...s]=e.split(".");this.event=t,this.namespace=new Set(s)}hasNamespace(e){Array.isArray(e)||(e=[e]);for(let t of e){if(!/^[\w:]+$/.test(t))throw new _.INVALID_VALUE({target:"namespace",reason:"must be alphanumeric, underscore and colon characters",given:t});if(t&&this.namespace.has(t))return t}return!1}addNamespace(e){if(!/^[\w:]+$/.test(e))throw new _.INVALID_VALUE({target:"namespace",reason:"must be alphanumeric, underscore and colon characters",given:e});this.namespace.add(e)}deleteNamespace(e){if(!/^[\w:]+$/.test(e))throw new _.INVALID_VALUE({target:"namespace",reason:"must be alphanumeric, underscore and colon characters",given:e});this.namespace.delete(e)}toString(){return this.namespace.size?this.event+"."+Array.from(this.namespace.values()).join("."):this.event}}z.validateSelector=function(e){L("JFactoryEvents.validateSelector(selector)",e).notUndefined().validSpaces();for(let[t,s]of e.split(" ").map(e=>e.split(".")).map(e=>[e.shift(),e.join(".")]))t&&z.validateEvent(t),s&&z.validateNamespace(s);return!0},z.validateEvent=function(e){if(L("JFactoryEvents.validateEvent(event)",e).notUndefined().notEmptyString().validSpaces(),!/^[\w:]+$/.test(e))throw new _.INVALID_VALUE({target:"JFactoryEvents.validateEvent(event)",reason:"must be alphanumeric, underscore and colon characters",given:e});return!0},z.validateNamespace=function(e){if(L("JFactoryEvents.validateNamespace(namespace)",e).notUndefined().notEmptyString().validSpaces(),!/^[\w:.]+$/.test(e))throw new _.INVALID_VALUE({target:"JFactoryEvents.validateNamespace(namespace)",reason:"must be alphanumeric, underscore, dot and colon characters",given:e});return!0};class ee extends J{constructor(e,t,s={}){if("function"==typeof e)super(e);else{"string"==typeof e&&([e,t,s]=[{},arguments[0],arguments[1]]);let r=new Request(t,s);super(e,(i,n)=>{let a=fetch(r).then(e=>{if(this.$chain.fetchResponse=e,!e.ok)throw Error(e.status+":"+e.statusText);return e});s.$typeText?a=a.then(e=>e.text()).then(e=>this.$chain.responseText=e):s.$typeJSON&&(a=a.then(e=>e.json()).then(e=>this.$chain.responseJSON=e)),(a=a.catch(i=>{throw new _.REQUEST_ERROR({reason:i.message||i,target:this.$chain.fetchResponse&&this.$chain.fetchResponse.url||t,owner:this,fetchOptions:s,fetchRequest:r,fetchResponse:this.$chain.fetchResponse||null},e.traceSource)})).then(i,n)}),this.$chain.fetchOptions=s,this.$chain.fetchRequest=r;let i=s.abortController||new AbortController;s.signal=i.signal,this.$chain.fetchAbortController=i}}$chainAbort(e="request aborted"){return super.$chainAbort(e),this.$chain.fetchAbortController.abort(),this}}const te=Symbol();class se{constructor(e){e&&L("JFactoryLogger(options)",e).properties(Object.getOwnPropertyNames(se.DEFAULT_CONFIG)),f(this,e,se.DEFAULT_CONFIG),this.condition=j(se.DEFAULT_CONDITION),this.installAccessor("log"),this.installAccessor("warn"),this.installAccessor("error")}get enabled(){return this[te]&&(!this.parentLogger||this.parentLogger.enabled)}set enabled(e){e?this.enable():this.disable()}enable(){!0!==this[te]&&(this[te]=!0)}disable(){!1!==this[te]&&(this[te]=!1)}disallow(e,t=this.label){this.filters[t]||(this.filters[t]={}),this.filters[t][e]=!0}allow(e,t=this.label){this.filters[t]&&delete this.filters[t][e]}installAccessor(e,t=e,s=this){L("JFactoryLogger(nativeName)",e).equalIn(["log","warn","error"]),Object.defineProperties(s,{[t]:{get:this.accessor.bind(this,e),configurable:!0}})}accessor(e){return this[te]&&this.condition(e)&&this.formatter[e](this)||b}createSubLogger(e){let t=new se({enabled:this.enabled,label:this.label+"."+e,styles_css:this.styles_css,styles_cli:this.styles_cli,console:this.console,formatter:this.formatter});return t.parentLogger=this,t.condition.addCondition(()=>this.enabled),t.filters=this.filters,t}}se.FORMATTER_NATIVE={log:e=>e.console.log.bind(e.console,e.label+">"),warn:e=>e.console.warn.bind(e.console,e.label+">"),error:e=>e.console.error.bind(e.console,e.label+">")},se.FORMATTER_CLI={log:e=>e.console.log.bind(e.console,e.styles_cli.label,e.label+">"),warn:e=>e.console.warn.bind(e.console,e.styles_cli.label,e.label+">"),error:e=>e.console.error.bind(e.console,e.styles_cli.label,e.label+">")},se.FORMATTER_BROWSER={log:e=>e.console.log.bind(e.console,"%c"+e.label+">",e.styles_css.label),warn:e=>e.console.warn.bind(e.console,"%c"+e.label+">",e.styles_css.label),error:e=>e.console.error.bind(e.console,"%c"+e.label+">",e.styles_css.label)},se.DEFAULT_CONDITION=function(e){return L("JFactoryLogger.condition(nativeName)",e).equalIn(["log","warn","error"]),L("JFactoryLogger.enabled",this.enabled).equal(!0),!(this.filters[this.label]&&this.filters[this.label][e])},se.DEFAULT_CONFIG={label:"",enabled:!0,parentLogger:null,formatter:i?se.FORMATTER_CLI:se.FORMATTER_BROWSER,console:console,filters:{},styles_cli:{label:"[1;30m%s[0m"},styles_css:{label:"color: gray"}};class re extends Date{toString(){return this.toLocaleTimeString()+", "+this.getUTCMilliseconds()+"ms ("+this.valueOf()+")"}$toDurationString(){let e=this.getUTCHours(),t=this.getUTCMinutes(),s=this.getUTCSeconds(),r=this.getUTCMilliseconds(),i=[];return e&&i.push(e+"h"),t&&i.push(t+"min"),s&&i.push(s+"s"),i.push(r+"ms"),1===i.length?i[0]:i.join(",")+" ("+this.valueOf()+")"}}class ie extends Date{constructor(){super(),this.elapsed=null,Object.defineProperties(this,{t1:{value:null,writable:!0},t0:{value:new re}})}end(){this.t1=new re,this.elapsed=new re(this.t1-this.t0).$toDurationString()}toString(){return this.elapsed}}class ne{trait_constructor(){const e=this;class t extends Map{$registerSync(t,s){let r=Object.defineProperties({},{$value:{value:s},$phaseRemove:{value:ue.getContextualRemovePhase(e)}});return this.set(t,r),r}$registerAsync(t,s,r){let i=e.$task(s,r.$chain);return r.$chain.then(()=>{i.$chainComplete("task completed")}),i.$chain.then(()=>{r.$chain.isCompleted||r.$chainAbort("aborted by task")}),Object.defineProperty(r,"$phaseRemove",{value:i.$phaseRemove}),this.set(t,r),i}}const s=Object.assign(Object.create(null),{[ne.SYMBOL_PRIVATE]:Object.create(null),assign:function(e,t,s){H.assign(this,e,t,s)},createSubMap:()=>new t});Object.defineProperty(this,"$",{value:Object.create(s)}),this.$.assign({tasks:null,requests:null},H.descriptors.ENUMERABLE_WRITABLE)}}ne.SYMBOL_PRIVATE=Symbol("_");class ae{trait_constructor(e){H.assign(this.$,"about",new Y(this,e),H.descriptors.READONLY)}}class oe{trait_constructor(){let e=Object.assign({label:this.$.about.name},n.TraitLog||{enabled:!1}),t=new se(e);Object.defineProperty(this.$,"logger",{value:t}),t.installAccessor("log","$log",this),t.installAccessor("warn","$logWarn",this),t.installAccessor("error","$logErr",this)}}class le{trait_constructor(){this.$.assign("tasks",new Map,H.descriptors.ENUMERABLE)}$task(e,t){if(L("$task(id)",e).typeString(),L("$task(executorOrValue)",t).notUndefined(),this.$.tasks.has(e))throw new _.KEY_DUPLICATED({target:"$task(id)",given:e});let s,r;return(s="function"==typeof t?new J({name:e,owner:this},t):J.resolve({name:e,owner:this},t)).$phaseRemove=ue.getContextualRemovePhase(this),r=new ie,s.$taskMetrics={$dev_timing:r},s.$chain.then(()=>{r.end(),this.$.tasks.get(e)&&this.$taskRemove(e)}),this.$.tasks.set(e,s),s}$taskRemove(e,t){if(L("$taskRemove(id)",e).typeString(),t&&L("$taskRemove(reason)",t).typeString(),!this.$.tasks.has(e))throw new _.KEY_MISSING({target:"$taskRemove(id)",given:e});this.$.tasks.get(e)._called,this.$.tasks.get(e)._called=!0;let s=this.$.tasks.get(e);this.$.tasks.delete(e),s.$chainAbort(t||"$taskRemove()")}$taskRemoveAll(e){L("$taskRemoveAll(removePhase)",e).equalIn(ue.PHASES);let t=this.$.tasks;if(t.size)for(const[s,r]of t)r.$phaseRemove===e&&this.$taskRemove(s,"$taskRemoveAll("+e+")")}$taskPromiseAll(e=!1){let t=[];if(this.$.tasks.size)for(let s of this.$.tasks.values())e&&(s.$chain.chainConfig.chainAutoComplete=!0),s.$chain.isPending&&t.push(s.$chain);return t.length?Promise.all(t):G.resolve()}}class ce{trait_constructor(){de(this,"events",{custom:new Q(this),kernel:new Q(this)},H.descriptors.NONE);let e=this.$[ne.SYMBOL_PRIVATE].events.custom;Object.defineProperties(this.$,{listeners:{get:e.getDomListeners.bind(e,this.$.about.fingerprint),enumerable:!0},observers:{get:e.getObservers.bind(e),enumerable:!0}})}$on(){this.$[ne.SYMBOL_PRIVATE].events.custom.on(...arguments)}$off(){this.$[ne.SYMBOL_PRIVATE].events.custom.off(...arguments)}$trigger(){return this.$[ne.SYMBOL_PRIVATE].events.custom.trigger(...arguments)}$triggerParallel(){return this.$[ne.SYMBOL_PRIVATE].events.custom.triggerParallel(...arguments)}$notify(e,t){return this.$trigger(e,t).then(()=>this.$[ne.SYMBOL_PRIVATE].events.kernel.trigger(e,t))}}class he{trait_constructor(){const e=Object.create(null),t=Object.create(null),s=this.$[ne.SYMBOL_PRIVATE].events.kernel;de(this,{states:e,stateRoutes:t},H.descriptors.READONLY),H.assign(this.$,"states",new Proxy(e,{set:(e,t,s)=>this.$state(t,s),get:(t,s)=>e[s]}),H.descriptors.READONLY),s.on("beforeStateChange",(e,s)=>{let r;if(t[s.key]&&t[s.key].before&&(r=t[s.key].before(s.val)))return this.$notify(r)}),s.on("afterStateChange",(e,s)=>{let r;if(t[s.key]&&t[s.key].after&&(r=t[s.key].after(s.val)))return this.$notify(r)})}$state(e,t,s=!0){return L("$state(key)",e).typeString(),L("$state(notify)",s).typeBoolean(),new G(async r=>{let i,n=this.$[ne.SYMBOL_PRIVATE].states,a=n[e];e in n&&a===t||((i=s&&this.$notify("beforeStateChange",{key:e,val:t,previousVal:a}))&&L("beforeStateChange result",i).type(G),i&&!i.$isSettled&&(n[e]=i,await i),void 0===t?delete n[e]:n[e]=t,(i=s&&this.$notify("afterStateChange",{key:e,val:t,previousVal:a}))&&L("afterStateChange result",i).type(G)),i?i.then(r):r()})}}class ue{trait_constructor(){H.assign(this.$,"service",Object.create(null),H.descriptors.READONLY),this.$.service.phase=ue.PHASE.NONE,this.$.service.phaseQueue=G.resolve(),this.$state("installed",!1,!1),this.$state("enabled",!1,!1),pe(this,"stateRoutes",{installed:{after:e=>e?"install":"uninstall"},enabled:{after:e=>e?"enable":"disable"}},H.descriptors.NONE);let e=this.$[ne.SYMBOL_PRIVATE].events.custom,t=this.$[ne.SYMBOL_PRIVATE].events.kernel;e.affiliateAddRule((e,t,s,r)=>ue.setEventNamespaceRemovePhase(this,t,r));let s=e=>{this.$.tasks.size&&this.$taskRemoveAll(this.$.service.phase);let t=G.resolve();return e&&(t=t.then(()=>e.call(this)).then(()=>this.$taskPromiseAll(!0))),t.catch(e=>{this.$.service.isPhaseKilling&&e instanceof _.PROMISE_EXPIRED||this.$logErr("unhandled promise rejection in "+this.$.service.phase+";",...e instanceof R?e:[e])})};t.on("install",()=>s(this.onInstall)),t.on("enable",()=>s(this.onEnable)),t.on("disable",()=>s(this.onDisable)),t.on("uninstall",()=>s(this.onUninstall)),t.on("disable",()=>this.$off({removal:ue.PHASE.DISABLE})),t.on("uninstall",()=>this.$off({removal:ue.PHASE.UNINSTALL}))}$install(e){return this.$.service.phaseQueue.$isSettled?(this.$.service.isPhaseKilling,this.$.service.phaseQueue=G.resolve().then(()=>{if(!this.$.states.installed)return this.$.service.phase=ue.PHASE.INSTALL,this.$state("installed",!0)}).then(()=>{if(e&&this.$.states.installed&&!this.$.states.enabled)return this.$.service.phase=ue.PHASE.ENABLE,this.$state("enabled",!0)}).then(()=>{this.$.service.phase=ue.PHASE.NONE})):this.$.service.phaseQueue.then(()=>this.$install())}$enable(){return this.$.service.phaseQueue.$isSettled?(this.$.service.isPhaseKilling,this.$.service.phaseQueue=G.resolve().then(()=>{if(this.$.states.installed&&!this.$.states.enabled)return this.$.service.phase=ue.PHASE.ENABLE,this.$state("enabled",!0)}).then(()=>{this.$.service.phase=ue.PHASE.NONE})):this.$.service.phaseQueue.then(()=>this.$enable())}$disable(){return this.$.service.phaseQueue.$isSettled?(this.$.service.isPhaseKilling,this.$.service.phaseQueue=G.resolve().then(()=>{if(this.$.states.enabled)return this.$.service.phase=ue.PHASE.DISABLE,this.$state("enabled",!1)}).then(()=>{this.$.service.phase=ue.PHASE.NONE})):ue.phaseKill(this).then(()=>this.$disable())}$uninstall(){return this.$.service.phaseQueue.$isSettled?(this.$.service.isPhaseKilling,this.$.service.phaseQueue=G.resolve().then(()=>{if(this.$.states.enabled)return this.$disable()}).then(()=>{if(this.$.states.installed)return this.$.service.phase=ue.PHASE.UNINSTALL,this.$state("installed",!1)}).then(()=>{this.$.service.phase=ue.PHASE.NONE})):ue.phaseKill(this).then(()=>this.$uninstall())}static phaseKill(e){return new Promise(t=>{e.$.service.phaseQueue.$isSettled?(e.$.service.isPhaseKilling=!1,t()):(e.$.service.isPhaseKilling=!0,e.$.tasks.size&&e.$taskRemoveAll(ue.getContextualRemovePhase(e),!0),setTimeout(()=>t(ue.phaseKill(e)),50))})}static getContextualRemovePhase(e){return ue.PHASE_REVERT[e.$.service.phase]}static setEventNamespaceRemovePhase(e,t,s){let r=t.hasNamespace(ue.PHASES),i=s&&s.removal;i||(i=ue.getContextualRemovePhase(e)),"uninstall"===t.event&&i===ue.PHASE.DISABLE&&(i=ue.PHASE.UNINSTALL),r!==i&&(t.deleteNamespace(r),t.addNamespace(i)),t.addNamespace(i)}}function de(e,t,s,r){H.assign(e.$[ne.SYMBOL_PRIVATE],t,s,r)}function pe(e,t,s,r){H.assign(e.$[ne.SYMBOL_PRIVATE][t],s,r)}ue.PHASE={NONE:"PHASE_NONE",INSTALL:"PHASE_INSTALL",ENABLE:"PHASE_ENABLE",DISABLE:"PHASE_DISABLE",UNINSTALL:"PHASE_UNINSTALL"},ue.PHASE_REVERT={[ue.PHASE.INSTALL]:ue.PHASE.UNINSTALL,[ue.PHASE.UNINSTALL]:ue.PHASE.INSTALL,[ue.PHASE.DISABLE]:ue.PHASE.ENABLE,[ue.PHASE.ENABLE]:ue.PHASE.DISABLE,[ue.PHASE.NONE]:ue.PHASE.DISABLE},ue.PHASES=Object.values(ue.PHASE),U.PHASE=H.disinherit(ue.PHASE),U.TraitCore=ne,U.TraitAbout=ae,U.TraitLog=oe,U.TraitEvents=ce,U.TraitState=he,U.TraitService=ue,U.TraitTask=le;class fe{trait_constructor(){const e=this.$[ne.SYMBOL_PRIVATE].events.kernel;e.on("disable",()=>this.$fetchRemoveAll(ue.PHASE.DISABLE)),e.on("uninstall",()=>this.$fetchRemoveAll(ue.PHASE.UNINSTALL)),this.$.assign("requests",this.$.createSubMap(),H.descriptors.ENUMERABLE)}$fetch(e,t,s={}){if(L("$fetch(id)",e).typeString(),L("$fetch(url)",t).typeString(),L("$fetch(fetchOptions)",s).typePlainObject(),this.$.requests.has(e))throw new _.KEY_DUPLICATED({target:"$fetch(id)",given:e});let r=new ee({name:e,traceSource:S.tracer.captureTraceSource("$fetch"),config:{chainAutoComplete:!0}},t,s);return this.$.requests.$registerAsync(e,'$fetch("'+e+'")',r),r.$chain.then(()=>{this.$.requests.has(e)&&this.$fetchRemove(e)}),r}$fetchText(e,t,s={}){return this.$fetch(e,t,{...s,$typeText:!0})}$fetchJSON(e,t,s={}){return this.$fetch(e,t,{...s,$typeJSON:!0})}$fetchRemove(e,t){if(L("$fetchRemove(id)",e).typeString(),t&&L("$fetchRemove(reason)",t).typeString(),!this.$.requests.has(e))throw new _.KEY_MISSING({target:"$fetchRemove(id)",given:e});this.$.requests.get(e)._debug_remove_called,this.$.requests.get(e)._debug_remove_called=!0;let s=this.$.requests.get(e);this.$.requests.delete(e),s.$chainAbort(t||"$fetchRemove()")}$fetchRemoveAll(e){L("removePhase",e).equalIn(ue.PHASES);let t=this.$.requests;if(t.size)for(const[s,r]of t)r.$phaseRemove===e&&this.$fetchRemove(s,"$fetchRemoveAll("+e+")")}}class me{trait_constructor(){const e=this.$[ne.SYMBOL_PRIVATE].events.kernel;e.on("disable",()=>this.$timeoutRemoveAll(ue.PHASE.DISABLE)),e.on("uninstall",()=>this.$timeoutRemoveAll(ue.PHASE.UNINSTALL)),this.$.assign("timeouts",this.$.createSubMap(),H.descriptors.ENUMERABLE)}$timeout(e,t,s=null,...r){if(L("id",e).typeString(),L("delay",t).typeNumber(),L("handler",s).type(Function,null),this.$.timeouts.has(e))throw new _.KEY_DUPLICATED({target:"$timeout(id)",given:e});let i,n=new J({name:e,traceSource:S.tracer.captureTraceSource("$timeout"),config:{chainAutoComplete:!0}},e=>{i=setTimeout(()=>{n.$isExpired||e(s?s(...r):void 0)},t)});return this.$.timeouts.$registerAsync(e,'$timeout("'+e+'")',n),n.$chain.data.timer=i,n.$chain.then(()=>{this.$.timeouts.has(e)&&this.$timeoutRemove(e)}),n}$timeoutRemove(e,t){if(L("$timeoutRemove(id)",e).typeString(),t&&L("$timeoutRemove(reason)",t).typeString(),!this.$.timeouts.has(e))throw new _.KEY_MISSING({target:"$timeoutRemove(id)",given:e});this.$.timeouts.get(e)._debug_remove_called,this.$.timeouts.get(e)._debug_remove_called=!0;let s=this.$.timeouts.get(e);clearTimeout(s.$chain.data.timer),this.$.timeouts.delete(e),s.$chainAbort(t||"$timeoutRemove()")}$timeoutRemoveAll(e){L("removePhase",e).equalIn(ue.PHASES);let t=this.$.timeouts;if(t.size)for(const[s,r]of t)r.$phaseRemove===e&&this.$timeoutRemove(s,"$timeoutRemoveAll()")}}class $e{trait_constructor(){const e=this.$[ne.SYMBOL_PRIVATE].events.kernel;e.on("disable",()=>this.$intervalRemoveAll(ue.PHASE.DISABLE)),e.on("uninstall",()=>this.$intervalRemoveAll(ue.PHASE.UNINSTALL)),this.$.assign("timeints",this.$.createSubMap(),H.descriptors.ENUMERABLE)}$interval(e,t,s,...r){if(L("id",e).typeString(),L("handler",s).typeFunction(),L("delay",t).typeNumber(),this.$.timeints.has(e))throw new _.KEY_DUPLICATED({target:"$interval(id)",given:e});let i=setInterval(s,t,...r);this.$.timeints.$registerSync(e,i)}$intervalRemove(e){if(L("$intervalRemove(id)",e).typeString(),!this.$.timeints.has(e))throw new _.KEY_MISSING({target:"$intervalRemove(id)",given:e});this.$.timeints.get(e)._debug_remove_called,this.$.timeints.get(e)._debug_remove_called=!0,clearInterval(this.$.timeints.get(e).$value),this.$.timeints.delete(e)}$intervalRemoveAll(e){L("removePhase",e).equalIn(ue.PHASES);let t=this.$.timeints;if(t.size)for(const[s,r]of t)r.$phaseRemove===e&&this.$intervalRemove(s)}}class ge{trait_constructor(){const e=this.$[ne.SYMBOL_PRIVATE].events.kernel;e.on("disable",()=>this.$mutationRemoveAll(ue.PHASE.DISABLE)),e.on("uninstall",()=>this.$mutationRemoveAll(ue.PHASE.UNINSTALL)),this.$.assign("mutations",this.$.createSubMap(),H.descriptors.ENUMERABLE)}$mutation(e,t,s,r){if(L("id",e).typeString(),L("parent",t).type(HTMLElement,Document),L("config",s).typePlainObject(),L("handler",r).typeFunction(),this.$.mutations.has(e))throw new _.KEY_DUPLICATED({target:"$mutation(id)",given:e});let i=new MutationObserver(r);i.observe(t,s),this.$.mutations.$registerSync(e,i)}$mutationRemove(e,t){if(L("$mutationRemove(id)",e).typeString(),t&&L("$mutationRemove(reason)",t).typeString(),!this.$.mutations.has(e))throw new _.KEY_MISSING({target:"$mutationRemove(id)",given:e});this.$.mutations.get(e)._debug_remove_called,this.$.mutations.get(e)._debug_remove_called=!0,this.$.mutations.get(e).$value.disconnect(),this.$.mutations.delete(e)}$mutationRemoveAll(e){L("removePhase",e).equalIn(ue.PHASES);let t=this.$.mutations;if(t.size)for(const[s,r]of t)r.$phaseRemove===e&&this.$mutationRemove(s)}}class ve{trait_constructor(){const e=this.$[ne.SYMBOL_PRIVATE].events.kernel;e.on("disable",()=>this.$domRemoveAll(ue.PHASE.DISABLE)),e.on("uninstall",()=>this.$domRemoveAll(ue.PHASE.UNINSTALL)),this.$.assign("dom",this.$.createSubMap(),H.descriptors.ENUMERABLE)}$dom(e,t){let s;if(L("id",e).typeString(),L("jQueryArgument",t).type(String,Object),"#"===e[0]&&(e=e.substring(1),s=!0),this.$.dom.has(e))throw new _.KEY_DUPLICATED({target:"$dom(id)",given:e});let r=c(t);return s&&(r[0].id=e),this.$.dom.$registerSync(e,r).$value}$domFetch(e,t,s){let r;if(L("id",e).typeString(),L("url",t).typeString(),"#"===e[0]&&(e=e.substring(1),r=!0),this.$.dom.has(e))throw new _.KEY_DUPLICATED({target:"$domFetch(id)",given:e});let i=this.$fetchText('$domFetch("'+e+'")',t,s).then(t=>{let s=c(t);return r&&(s[0].id=e),s});return this.$.dom.$registerAsync(e,'$domFetch("'+e+'")',i),i}$domRemove(e,t){if(L("$domRemove(id)",e).typeString(),t&&L("$domRemove(reason)",t).typeString(),!this.$.dom.has(e))throw new _.KEY_MISSING({target:"$domRemove(id)",given:e});this.$.dom.get(e)._debug_remove_called,this.$.dom.get(e)._debug_remove_called=!0;let s=this.$.dom.get(e),r=s.$value;r instanceof c&&r.remove(),s instanceof ee&&s.$chainAbort(t||"$domRemove()"),this.$.dom.delete(e)}$domRemoveAll(e){L("removePhase",e).equalIn(ue.PHASES);let t=this.$.dom;if(t.size)for(const[s,r]of t)r.$phaseRemove===e&&this.$domRemove(s)}}class be{trait_constructor(){const e=this.$[ne.SYMBOL_PRIVATE].events.kernel;e.on("disable",()=>this.$cssRemoveAll(ue.PHASE.DISABLE)),e.on("uninstall",()=>this.$cssRemoveAll(ue.PHASE.UNINSTALL)),this.$.assign("css",this.$.createSubMap(),H.descriptors.ENUMERABLE)}$css(e,t){let s;if(L("id",e).typeString(),L("css",t).typeString(),"#"===e[0]&&(e=e.substring(1),s=!0),this.$.css.has(e))throw new _.KEY_DUPLICATED({target:"$css(id)",given:e});return this.$.css.$registerSync(e,c("<style>").attr(s?{id:e}:{}).addClass("jFactory-css").html(t).appendTo("head")).$value}$cssFetch(e,t){let s,r;if(L("id",e).typeString(),L("url",t).typeString(),"#"===e[0]&&(e=e.substring(1),s=!0),this.$.css.has(e))throw new _.KEY_DUPLICATED({target:"$cssFetch(id)",given:e});let i=new J({name:e,config:{chainAutoComplete:!0},traceSource:S.tracer.captureTraceSource("$cssFetch")},i=>r=c("<link>",{id:s?e:"",rel:"stylesheet",type:"text/css"}).addClass("jFactory-css").appendTo("head").on("load",()=>{i(r)}).attr("href",t));return i.$chain.data.dom=r,this.$.css.$registerAsync(e,'$cssFetch("'+e+'")',i),i}$cssRemove(e,t){if(L("$cssRemove(id)",e).typeString(),t&&L("$cssRemove(reason)",t).typeString(),!this.$.css.has(e))throw new _.KEY_MISSING({target:"$cssRemove(id)",given:e});this.$.css.get(e)._debug_remove_called,this.$.css.get(e)._debug_remove_called=!0;let s=this.$.css.get(e),r=s.$value||s.$chain&&s.$chain.data.dom;r instanceof c&&r.remove(),s instanceof J&&s.$chainAbort(t||"$cssRemove()"),this.$.css.delete(e)}$cssRemoveAll(e){L("removePhase",e).equalIn(ue.PHASES);let t=this.$.css;if(t.size)for(const[s,r]of t)r.$phaseRemove===e&&this.$cssRemove(s)}}U.TraitFetch=fe,U.TraitTimeout=me,U.TraitInterval=$e,U.TraitMutation=ge,U.TraitDOM=ve,U.TraitCSS=be,"undefined"!=typeof jFactoryOverride&&jFactoryOverride||a.init();export{i as JFACTORY_CLI,r as JFACTORY_DEBUG,s as JFACTORY_DEV,Y as JFactoryAbout,B as JFactoryComponent,D as JFactoryCoreObject,R as JFactoryError,Z as JFactoryEventSelector,X as JFactoryEventSelectorParser,z as JFactoryEvents,Q as JFactoryEventsManager,L as JFactoryExpect,ee as JFactoryFetch,T as JFactoryFunctionComposer,C as JFactoryFunctionConditional,N as JFactoryFunctionExpirable,F as JFactoryFunctionWrappable,se as JFactoryLogger,H as JFactoryObject,J as JFactoryPromise,W as JFactoryPromiseChain,K as JFactoryPromisePath,G as JFactoryPromiseSync,re as JFactoryTime,ie as JFactoryTimeTrace,y as JFactoryTrace_LIB_STACKTRACE,A as JFactoryTrace_NOFILTER,w as JFactoryTraits,ae as TraitAbout,be as TraitCSS,ne as TraitCore,ve as TraitDOM,ce as TraitEvents,fe as TraitFetch,$e as TraitInterval,oe as TraitLog,ge as TraitMutation,ue as TraitService,he as TraitState,le as TraitTask,me as TraitTimeout,de as assignPrivate,pe as assignPrivateMember,U as jFactory,n as jFactoryConfig,o as jFactoryDev,_ as jFactoryError,j as jFactoryFunctionConditional,I as jFactoryFunctionExpirable,k as jFactoryFunctionWrappable,l as jFactoryInit,a as jFactoryLoader,S as jFactoryTrace,M as jFactoryTraits};
//# sourceMappingURL=jFactory-devel.mjs.map
